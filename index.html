<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body style="background-color: #726f70">

<div style="width: 100%; padding: 0px; margin: 0px; text-align: center;margin-bottom: 1vh">
     <img src="logo.png" alt="logo" width="400" height="280"> 
</div>


<p id="result" style="width: 100%; margin-bottom: 10px; text-align: center;font-weight: bold;font-size: 36px;"></p>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Buraco')" style="background-color: #83fcd4; margin-right: 5vw">Buraco</button>
    <button onclick="getLocation('Desnivel')" style="background-color: #b5fc83">Desnível</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Curva')" style="background-color: #fcd083; margin-right: 5vw">Curva de nível</button>
    <button onclick="getLocation('Poça')" style="background-color: #c184fb">Poça D'água</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Quebra-molas')" style="background-color: #e8ffba; margin-right: 5vw">Quebra-molas</button>
    <button onclick="getLocation('Cruzamento')" style="background-color: #bad5ff">Cruzamento</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Ponte sobre rio')" style="background-color: #ffd6ba; margin-right: 5vw">Ponte sobre rio</button>
    <button onclick="getLocation('Banca de areia')" style="background-color: #ffa8cc">Banca de areia</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Costela')" style="background-color: #fc8385;" id="costelaButton">Costela de Vaca</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center; height: 5vh">
    <input id="vehicle" type="text" class="form-control " name="vehicle" value="" placeholder="Veículo" 
    style="width: 90%; height: 100%; font-size: 38px">
</div>

<input type="file" style="display: none;" id="uploadImage" accept="image/*">

<p id="sendDataResult" style="width: 100%; margin-bottom: 10px; margin-top: 5vh;text-align: center;font-weight: bold;font-size: 36px;"></p>
<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="sendToServer()" style="background-color: #64969e;width: 60vw" id="sendButton">
        Enviar dados
    </button>     
</div>


<style type="text/css">
    button {
        border-radius: 10px;
        height:10vh;
        width:40vw;
        font-weight: bold;
        font-size: 40px;
        margin-bottom: 5vh;    
    }
</style>

<script>
var x = document.getElementById("sendDataResult");
var y = document.getElementById("result");
var apontamentos = []
document.getElementById("vehicle").value = localStorage.getItem('vehicle')
var apntTypeGet = localStorage.getItem('apntType')
var apntLatGet = localStorage.getItem('apntLat')
var apntLngGet = localStorage.getItem('apntLng')
var apntTimestampGet = localStorage.getItem('apntTimestamp')
var apntType = []
var apntLat = []
var apntLng = []
var apntTimestamp = []
var costelaOn = false
var costelaButtonBlinkFactor = false
var costelaButtonColors = ["#fc8385", "#fafc83"]
var costelaInterval = null
var images = []

initializeArrays();

function initializeArrays() {
    if (!apntTypeGet) {
        apntType = []
    } else {
        apntType = apntTypeGet.split(',');
    }

    if (!apntLatGet) {
        apntLat = []
    } else {
        apntLat = apntLatGet.split(',');
    }

    if (!apntLngGet) {
        apntLng = []
    } else {
        apntLng = apntLngGet.split(',');
    }

    if (!apntTimestampGet) {
        apntTimestamp = []
    } else {
        apntTimestamp = apntTimestampGet.split(',');
    }

    if (apntType.length > 0) {
        confirm("Há dados a serem enviados")
    }
}

function blinkCostela() {
    var buttonElement = document.getElementById("costelaButton")
    costelaButtonBlinkFactor = !costelaButtonBlinkFactor;
    buttonElement.style.backgroundColor = costelaButtonBlinkFactor ? costelaButtonColors[0] : costelaButtonColors[1]
}

function addApntToLocalStorage(type) {
    apntType.push(type)
    apntLat.push(0)
    apntLng.push(0)
    apntTimestamp.push(new Date().valueOf().toString())

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)
    localStorage.setItem('apntType', apntType)
    localStorage.setItem('apntLat', apntLat)
    localStorage.setItem('apntLng', apntLng)
    localStorage.setItem('apntTimestamp', apntTimestamp)
}

function getLocation(type) {
    x.innerHTML = ""
    if (navigator.geolocation) {
        var inputImage = document.getElementById('uploadImage')

        inputImage.onchange = e => { 
            images.push(e.target.files[0])
        }

        images.forEach(imgm => {
            console.log(imgm.name)
            console.log(imgm.size)
        })

        inputImage.click();


        if (type === 'Buraco') {
          if (confirm("Deseja apontar um buraco na pista?")) {
            addApntToLocalStorage('Buraco');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Desnivel') {
          if (confirm("Deseja apontar um desnível na pista?")) {
            addApntToLocalStorage('Desnivel');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Curva') {
          if (confirm("Deseja apontar uma curva de nível?")) {
            addApntToLocalStorage('Curva');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Poça') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Poca');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Quebra-molas') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Quebra-molas');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Cruzamento') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Cruzamento');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Ponte sobre rio') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Ponte');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Banca de areia') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Banca de areia');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Costela') {
            if (!costelaOn) {
                if (confirm("Deseja começar a apontar costela de vaca na pista?")) {
                    addApntToLocalStorage('Costela-Start');
                    navigator.geolocation.getCurrentPosition(sendPosition);
                    costelaInterval = setInterval(blinkCostela, 800);

                    var costelaElement = document.getElementById("costelaButton")
                    costelaElement.innerHTML = "Costela de Vaca - Parar";
                    costelaOn = !costelaOn
                }
            } else {
                if (confirm("Deseja parar de apontar costela de vaca na pista?")) {
                    addApntToLocalStorage('Costela-End');
                    navigator.geolocation.getCurrentPosition(sendPosition);
                    clearInterval(costelaInterval)

                    var costelaElement = document.getElementById("costelaButton")
                    costelaElement.innerHTML = "Costela de Vaca";
                    costelaElement.style.backgroundColor = costelaButtonColors[0]
                    costelaOn = !costelaOn
                }
            }
        }
    } else { 
        x.innerHTML = "Não é possível apontar com este navegador. Por favor, tente em outro.";
    }
}

function updateLocalStorageWithCoordinates(lat, lng) {
    
    apntLat[apntLat.length - 1] = lat;
    apntLng[apntLng.length - 1] = lng;

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)
    localStorage.setItem('apntType', apntType)
    localStorage.setItem('apntLat', apntLat)
    localStorage.setItem('apntLng', apntLng)
    localStorage.setItem('apntTimestamp', apntTimestamp)    
}

function sendPosition(position) {
    updateLocalStorageWithCoordinates(position.coords.latitude, position.coords.longitude)
    y.innerHTML = "Ponto " + position.coords.latitude.toFixed(4) + "|" + position.coords.longitude.toFixed(4) + " adicionado"
}

function sendToServer() {

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)

    let typeFromLS = localStorage.getItem('apntType')
    let latFromLS = localStorage.getItem('apntLat')
    let lngFromLS = localStorage.getItem('apntLng')
    let timestampFromLS = localStorage.getItem('apntTimestamp')

    let typeToSend = []
    let latToSend = []
    let lngToSend = []
    let timestampToSend = []
    let vehicleToSend = document.getElementById("vehicle").value;

    if (vehicleToSend === '') {
        confirm("Insira o nome do veículo")
        return;
    }


    if (!typeFromLS) {
        typeToSend = []
    } else {
        typeToSend = typeFromLS.split(',');
    }

    if (!latFromLS) {
        latToSend = []
    } else {
        latToSend = latFromLS.split(',');
    }

    if (!lngFromLS) {
        lngToSend = []
    } else {
        lngToSend = lngFromLS.split(',');
    }

    if (!timestampFromLS) {
        timestampToSend = []
    } else {
        timestampToSend = timestampFromLS.split(',');
    }

    if (!timestampFromLS || timestampFromLS.length === 0) {
        confirm("Nada para enviar.")
        return;
    }

    let apontamentos = []
    for (let i = 0; i < typeToSend.length; i++ ) {
        apontamentos.push({
            vehicle: vehicleToSend,
            type_ap: typeToSend[i],
            lat: latToSend[i],
            lng: lngToSend[i],
            timestamp: timestampToSend[i]
        })
    }
  
    let apontamentoToSend = {
       apnt: apontamentos
    }

    var sendButtonElement = document.getElementById("sendButton")

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            y.innerHTML = ""
            x.innerHTML = "Apontado com sucesso"
            document.getElementById("vehicle").value = ''
            apontamentos = []
            apntType = []
            apntLat = []
            apntLng = []
            apntTimestamp = []
            localStorage.clear()
        }
        sendButtonElement.innerHTML = "Enviar dados"
    };
    xhttp.open("POST", "https://lots-iotag.herokuapp.com/write", true);
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send(JSON.stringify(apontamentoToSend));

    
    sendButtonElement.innerHTML = "<i class=\"fa fa-circle-o-notch fa-spin\"></i> Enviar dados"
}

</script>

</body>
</html>