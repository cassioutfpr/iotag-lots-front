<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

</head>

<body style="background-color: #726f70">



<div style="width: 100%; padding: 0px; margin: 0px; text-align: center;margin-bottom: 1vh">
     <img src="logo.png" alt="logo" width="400" height="280"> 
</div>


<p id="result" style="width: 100%; margin-bottom: 10px; text-align: center;font-weight: bold;font-size: 36px;"></p>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Buraco')" style="background-color: #83fcd4; margin-right: 5vw">Buraco</button>
    <button onclick="getLocation('Desnivel')" style="background-color: #b5fc83">Desnível</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Curva')" style="background-color: #fcd083; margin-right: 5vw">Curva de nível</button>
    <button onclick="getLocation('Poça')" style="background-color: #c184fb">Poça D'água</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Quebra-molas')" style="background-color: #e8ffba; margin-right: 5vw">Quebra-molas</button>
    <button onclick="getLocation('Cruzamento')" style="background-color: #bad5ff">Cruzamento</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Ponte sobre rio')" style="background-color: #ffd6ba; margin-right: 5vw">Ponte sobre rio</button>
    <button onclick="getLocation('Banca de areia')" style="background-color: #ffa8cc">Banca de areia</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="getLocation('Costela')" style="background-color: #fc8385;" id="costelaButton">Costela de Vaca</button>
</div>

<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center; height: 5vh">
    <input id="vehicle" type="text" class="form-control " name="vehicle" value="" placeholder="Veículo" 
    style="width: 90%; height: 100%; font-size: 38px">
</div>

<input type="file" style="display: none;" id="uploadImage" accept="image/*">

<p id="sendDataResult" style="width: 100%; margin-bottom: 10px; margin-top: 5vh;text-align: center;font-weight: bold;font-size: 36px;"></p>
<div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;">
    <button onclick="sendToServer()" style="background-color: #64969e;width: 60vw" id="sendButton">
        Enviar dados
    </button>     
</div>


<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content" style="text-align: center">
    <p style="font-weight: bold">Dê uma nota ao apontamento</p>

    <div class="btn-group" role="group" aria-label="Basic outlined example">
        <button type="button" class="btn btn-outline-primary" 
        style="font-size: 36px;margin-bottom: 5px;" onclick="setNota(1)" >1</button>
        <button type="button" class="btn btn-outline-primary" 
        style="font-size: 36px;margin-bottom: 5px;" onclick="setNota(2)">2</button>
        <button type="button" class="btn btn-outline-primary" 
        style="font-size: 36px;margin-bottom: 5px;" onclick="setNota(3)">3</button>
        <button type="button" class="btn btn-outline-primary" 
        style="font-size: 36px;margin-bottom: 5px;" onclick="setNota(4)">4</button>
        <button type="button" class="btn btn-outline-primary" 
        style="font-size: 36px;margin-bottom: 5px;" onclick="setNota(5)">5</button>
    </div>

    <div style="font-weight: bold;margin-bottom: 5vh;">
        Nota: <p id="nota" style="display: inline;font-size: 62"></p>
    </div>

    <div style="width: 100%; padding: 0px; margin: 0px; display: flex;justify-content: center;margin-bottom: 0;font-size: 36px">
        <button type="button" class="btn btn-warning" onclick="getImage()" id="imageButton"
        style="margin-right: 5vw;margin-bottom: 0;font-size: 36px;font-weight: bold">Foto</button>
        <button type="button" class="btn btn-primary" onclick="saveNota()" 
        style="margin-bottom: 0;font-size: 36px;font-weight: bold">Salvar</button>
    </div>

  </div>

</div>

<style type="text/css">
    button {
        border-radius: 10px;
        height:10vh;
        width:40vw;
        font-weight: bold;
        font-size: 40px;
        margin-bottom: 5vh;    
    }
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        font-size: 36px
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<script>
var x = document.getElementById("sendDataResult");
var y = document.getElementById("result");
var apontamentos = []
document.getElementById("vehicle").value = localStorage.getItem('vehicle')
var apntTypeGet = localStorage.getItem('apntType')
var apntLatGet = localStorage.getItem('apntLat')
var apntLngGet = localStorage.getItem('apntLng')
var apntTimestampGet = localStorage.getItem('apntTimestamp')
var apntNotaGet = localStorage.getItem('apntNota')
var apntType = []
var apntLat = []
var apntLng = []
var apntTimestamp = []
var apntNota = []
var costelaOn = false
var costelaButtonBlinkFactor = false
var costelaButtonColors = ["#fc8385", "#fafc83"]
var costelaInterval = null
var images = []
var nota = 1

initializeArrays();



// Get the modal
var modal = document.getElementById("myModal");

var notaHtml = document.getElementById("nota");

var imageButton = document.getElementById('imageButton')


function setNota(argument) {
    this.nota = argument
    notaHtml.innerHTML = this.nota
}

function saveNota() {
    apntNota[apntNota.length - 1] = this.nota
    localStorage.setItem('apntNota', apntNota)
    modal.style.display = "none";
    imageButton.classList.remove('disabled')
}

function getImage() {
        
    var inputImage = document.getElementById('uploadImage')
    
    var timestamp = this.apntTimestamp[apntTimestamp.length - 1]

    inputImage.onchange = e => { 
        var blob = e.target.files[0].slice(0, e.target.files[0].size, 'image/png'); 
        newFile = new File([blob], timestamp + '.png', {type: 'image/png'});
        
        images.push(newFile)
        imageButton.classList.add('disabled')
    }

    /*images.forEach(imgm => {
        Object.defineProperty(imgm, 'name', {
          writable: true,
          value: apntTimestampGet + '.png'
        });
        console.log(imgm.name)
        console.log(imgm.size)
    })*/

    inputImage.click(); 
}

function initializeArrays() {
    if (!apntTypeGet) {
        apntType = []
    } else {
        apntType = apntTypeGet.split(',');
    }

    if (!apntLatGet) {
        apntLat = []
    } else {
        apntLat = apntLatGet.split(',');
    }

    if (!apntLngGet) {
        apntLng = []
    } else {
        apntLng = apntLngGet.split(',');
    }

    if (!apntTimestampGet) {
        apntTimestamp = []
    } else {
        apntTimestamp = apntTimestampGet.split(',');
    }

    if (!apntNotaGet) {
        apntNota = []
    } else {
        apntNota = apntNotaGet.split(',');
    }


    if (apntType.length > 0) {
        confirm("Há dados a serem enviados")
    }
}

function blinkCostela() {
    var buttonElement = document.getElementById("costelaButton")
    costelaButtonBlinkFactor = !costelaButtonBlinkFactor;
    buttonElement.style.backgroundColor = costelaButtonBlinkFactor ? costelaButtonColors[0] : costelaButtonColors[1]
}

function addApntToLocalStorage(type) {
    apntType.push(type)
    apntLat.push(0)
    apntLng.push(0)
    apntTimestamp.push(new Date().valueOf().toString())
    apntNota.push(0)

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)
    localStorage.setItem('apntType', apntType)
    localStorage.setItem('apntLat', apntLat)
    localStorage.setItem('apntLng', apntLng)
    localStorage.setItem('apntTimestamp', apntTimestamp)
    localStorage.setItem('apntNota', apntNota)
}

function getLocation(type) {
    x.innerHTML = ""
    notaHtml.innerHTML = this.nota
    if (navigator.geolocation) {
        if (type === 'Buraco') {
          if (confirm("Deseja apontar um buraco na pista?")) {
            addApntToLocalStorage('Buraco');
            modal.style.display = "block";
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Desnivel') {
          if (confirm("Deseja apontar um desnível na pista?")) {
            addApntToLocalStorage('Desnivel');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Curva') {
          if (confirm("Deseja apontar uma curva de nível?")) {
            addApntToLocalStorage('Curva');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Poça') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Poca');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Quebra-molas') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Quebra-molas');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Cruzamento') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Cruzamento');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Ponte sobre rio') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Ponte');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Banca de areia') {
          if (confirm("Deseja apontar uma poça d'água na pista?")) {
            addApntToLocalStorage('Banca de areia');
            navigator.geolocation.getCurrentPosition(sendPosition);
          }
        }
        if (type === 'Costela') {
            if (!costelaOn) {
                if (confirm("Deseja começar a apontar costela de vaca na pista?")) {
                    addApntToLocalStorage('Costela-Start');
                    navigator.geolocation.getCurrentPosition(sendPosition);
                    costelaInterval = setInterval(blinkCostela, 800);

                    var costelaElement = document.getElementById("costelaButton")
                    costelaElement.innerHTML = "Costela de Vaca - Parar";
                    costelaOn = !costelaOn
                }
            } else {
                if (confirm("Deseja parar de apontar costela de vaca na pista?")) {
                    addApntToLocalStorage('Costela-End');
                    navigator.geolocation.getCurrentPosition(sendPosition);
                    clearInterval(costelaInterval)

                    var costelaElement = document.getElementById("costelaButton")
                    costelaElement.innerHTML = "Costela de Vaca";
                    costelaElement.style.backgroundColor = costelaButtonColors[0]
                    costelaOn = !costelaOn
                }
            }
        }
    } else { 
        x.innerHTML = "Não é possível apontar com este navegador. Por favor, tente em outro.";
    }
}

function updateLocalStorageWithCoordinates(lat, lng) {
    
    apntLat[apntLat.length - 1] = lat;
    apntLng[apntLng.length - 1] = lng;

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)
    localStorage.setItem('apntType', apntType)
    localStorage.setItem('apntLat', apntLat)
    localStorage.setItem('apntLng', apntLng)
    localStorage.setItem('apntTimestamp', apntTimestamp)    
}

function sendPosition(position) {
    updateLocalStorageWithCoordinates(position.coords.latitude, position.coords.longitude)
    y.innerHTML = "Ponto " + position.coords.latitude.toFixed(4) + "|" + position.coords.longitude.toFixed(4) + " adicionado"
}

function sendToServer() {

    localStorage.setItem('vehicle', document.getElementById("vehicle").value)

    let typeFromLS = localStorage.getItem('apntType')
    let latFromLS = localStorage.getItem('apntLat')
    let lngFromLS = localStorage.getItem('apntLng')
    let timestampFromLS = localStorage.getItem('apntTimestamp')
    let notaFromLS = localStorage.getItem('apntNota')

    let typeToSend = []
    let latToSend = []
    let lngToSend = []
    let timestampToSend = []
    let notaToSend = []
    let vehicleToSend = document.getElementById("vehicle").value;

    if (vehicleToSend === '') {
        confirm("Insira o nome do veículo")
        return;
    }


    if (!typeFromLS) {
        typeToSend = []
    } else {
        typeToSend = typeFromLS.split(',');
    }

    if (!latFromLS) {
        latToSend = []
    } else {
        latToSend = latFromLS.split(',');
    }

    if (!lngFromLS) {
        lngToSend = []
    } else {
        lngToSend = lngFromLS.split(',');
    }

    if (!timestampFromLS) {
        timestampToSend = []
    } else {
        timestampToSend = timestampFromLS.split(',');
    }

    if (!notaFromLS) {
        notaToSend = []
    } else {
        notaToSend = notaFromLS.split(',');
    }

    if (!timestampFromLS || timestampFromLS.length === 0) {
        confirm("Nada para enviar.")
        return;
    }

    let apontamentos = []
    for (let i = 0; i < typeToSend.length; i++ ) {
        apontamentos.push({
            vehicle: vehicleToSend,
            type_ap: typeToSend[i],
            lat: latToSend[i],
            lng: lngToSend[i],
            timestamp: timestampToSend[i],
            nota: notaToSend[i]
        })
    }
  
    let apontamentoToSend = {
       apnt: apontamentos
    }

    var sendButtonElement = document.getElementById("sendButton")
    
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            apontamentos = []
            apntType = []
            apntLat = []
            apntLng = []
            apntTimestamp = []
            apntNota = []
            localStorage.clear()
            sendImages()
        }
        sendButtonElement.innerHTML = "Enviar dados"
    };
    xhttp.open("POST", "https://lots-iotag.herokuapp.com/write", true);
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send(JSON.stringify(apontamentoToSend));

    sendImages()
    sendButtonElement.innerHTML = "<i class=\"fa fa-circle-o-notch fa-spin\"></i> Enviar dados"
}

function sendImages() {
    var data = new FormData();

    sendButtonElement.innerHTML = "<i class=\"fa fa-circle-o-notch fa-spin\"></i> Enviar dados"

    images.forEach(imgm => {
        data.append('file[]', imgm);
        console.log(imgm.name)
    })
    
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            y.innerHTML = ""
            x.innerHTML = "Apontado com sucesso"
            document.getElementById("vehicle").value = ''
        }
        sendButtonElement.innerHTML = "Enviar dados"
    };
    xhttp.open("POST", "https://lots-iotag.herokuapp.com/upload", true);
    xhttp.send(data);
}

</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

</body>
</html>